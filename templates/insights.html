<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inception-match</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-insights.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="{{ url_for('static', filename='images/nvidia-logo.png') }}" alt="NVIDIA Logo" class="logo-img">
                    </div>
                    <span class="logo-text">Inception-match</span>
                </div>
            </div>
            <div class="header-right">
                <!-- <div class="datetime">
                    <span id="current-datetime">25 de Setembro, 2024 16:12</span>
                </div> -->
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="/" class="sidebar-back">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </nav>

            <div class="chat-area-container">
                <!-- <div class="chat-list-panel">
                    <div class="chat-list-header">
                        <button class="new-chat-btn"><i class="fas fa-plus"></i> New Chat</button>
                        <button class="expand-chat-btn"><i class="fas fa-expand-alt"></i></button>
                    </div>
                    <div class="search-bar">
                        <input type="text" placeholder="Search chats..." class="search-input">
                    </div>
                    <div class="no-chats-message">
                        No chats.
                    </div>
                </div> -->

                <div class="chat-window">
                    <div class="chat-messages-display">
                        <div class="empty-chat-message"></div>
                        <div class="messages-container" aria-live="polite"></div>
                    </div>
                    <div class="chat-suggestions">
                        <span class="suggestions-title">Sugestões:</span>
                        <div class="suggestions-list">
                            <button type="button" class="suggestion-btn">Qual a startup com maior potencial de crescimento para o ano que vem na América Latina?</button>
                            <!-- <button type="button" class="suggestion-btn">Qual startup que devo entrar em contato hoje para o programa inception?</button> -->
                            <button type="button" class="suggestion-btn">Quais startups estão liderando IA no Chile?</button>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <i class="fas fa-plus-circle chat-input-icon"></i>
                        <input type="text" placeholder="Send a message..." class="message-input">
                        <button class="send-message-btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <span class="copyright">© 2025 Todos os direitos reservados.</span>
        <a href="#" class="privacy-policy">Política de Privacidade</a>
    </footer>

    <script>
        // Fill message input with suggestion text and focus the input when a suggestion is clicked
        (function(){
            document.addEventListener('DOMContentLoaded', function(){
                const suggestions = document.querySelectorAll('.suggestion-btn');
                const input = document.querySelector('.message-input');
                const sendBtn = document.querySelector('.send-message-btn');
                const messagesContainer = document.querySelector('.messages-container');

                function appendMessage(text, who, extraClass=''){
                    const el = document.createElement('div');
                    el.className = `msg ${who} ${extraClass}`.trim();
                    el.textContent = text;
                    messagesContainer.appendChild(el);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    return el;
                }

                async function sendMessage(text){
                    if(!text) return;
                    appendMessage(text, 'user');
                    input.value = '';

                    // loading bubble
                    const loading = document.createElement('div');
                    loading.className = 'msg bot loading';
                    loading.textContent = '...';
                    messagesContainer.appendChild(loading);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    try{
                        const resp = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({message: text})
                        });
                        const data = await resp.json();
                        messagesContainer.removeChild(loading);

                        if(resp.ok && data.answer){
                            const botEl = appendMessage(data.answer, 'bot');
                            // se houver fontes, renderize abaixo
                            if(Array.isArray(data.sources) && data.sources.length){
                                const srcList = document.createElement('div');
                                srcList.className = 'bot-sources';
                                data.sources.forEach(s => {
                                    const a = document.createElement('a');
                                    a.href = s.link;
                                    a.target = '_blank';
                                    a.rel = 'noopener noreferrer';
                                    a.textContent = s.title || s.link;
                                    a.className = 'bot-source-link';
                                    srcList.appendChild(a);
                                });
                                messagesContainer.appendChild(srcList);
                            }
                        } else if(data.error){
                            appendMessage('Erro: ' + data.error, 'bot');
                        } else {
                            appendMessage('Desculpe, não consegui obter resposta.', 'bot');
                        }
                    }catch(err){
                        messagesContainer.removeChild(loading);
                        appendMessage('Erro de conexão ao enviar a mensagem.', 'bot');
                    }
                }

                if(suggestions.length && input){
                    suggestions.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const text = btn.textContent.trim();
                            input.value = text;
                            input.focus();

                            // small visual feedback
                            btn.classList.add('suggestion-active');
                            setTimeout(() => btn.classList.remove('suggestion-active'), 250);
                        });
                    });
                }

                if(sendBtn && input){
                    sendBtn.addEventListener('click', () => sendMessage(input.value.trim()));

                    input.addEventListener('keydown', (e) => {
                        if(e.key === 'Enter' && !e.shiftKey){
                            e.preventDefault();
                            sendMessage(input.value.trim());
                        }
                    });
                }
            });
        })();
    </script>
</body>
</html>